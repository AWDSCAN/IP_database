name: Daily Update IP database

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 12 * * *'
    
env:
  innoextract_version: 1.9
  arch: amd64
 
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4
          sudo apt-get update
          sudo apt-get install -y wget unzip

      - name: Download innoextract
        continue-on-error: true
        run: |
          wget -q https://github.com/dscharrer/innoextract/releases/download/1.9/innoextract-1.9-linux.tar.xz
          tar -xf innoextract-1.9-linux.tar. xz
          chmod +x innoextract

      - name: Update qqwry.dat
        continue-on-error: true
        run: |
          python qqwry.py || true
          if [ -f *. zip ]; then
            unzip -o *.zip
            if [ -f innoextract ] && [ -f setup.exe ]; then
              ./innoextract setup.exe -I qqwry.dat
              [ -d app ] && mv app/qqwry.dat qqwry/qqwry.dat && rm -rf app
            fi
          fi
          rm -f setup.exe *.zip* innoextract-*.tar.xz
          
      - name: Update GeoLite2-ASN
        continue-on-error: true
        run: wget -q --timeout=30 --tries=3 https://github.com/P3TERX/GeoLite. mmdb/raw/download/GeoLite2-ASN.mmdb -O geolite/GeoLite2-ASN.mmdb

      - name: Update GeoLite2-City
        continue-on-error: true
        run: wget -q --timeout=30 --tries=3 https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb -O geolite/GeoLite2-City.mmdb

      - name: Update GeoLite2-Country
        continue-on-error: true
        run: wget -q --timeout=30 --tries=3 https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-Country. mmdb -O geolite/GeoLite2-Country. mmdb

      - name: Update ip2region
        continue-on-error: true
        run: wget -q --timeout=30 --tries=3 https://github.com/lionsoul2014/ip2region/raw/master/data/ip2region_v4.xdb -O ip2region/ip2region.xdb
          
      - name: Update 17monipdb
        continue-on-error: true
        run: wget -q --timeout=30 --tries=3 https://github.com/igreedy/ip_finder/raw/master/17monipdb.dat -O 17monipdb/17monipdb.dat
      
      - name: Update IPDB
        continue-on-error: true
        run: wget -q --timeout=30 --tries=3 https://raw.githubusercontent. com/ipipdotnet/ipdb-go/master/city.free.ipdb -O ipdb/city.free. ipdb
      
      - name: Update DB-IP City
        continue-on-error: true
        run: wget -q --timeout=30 --tries=3 "https://github.com/sapics/ip-location-db/raw/refs/heads/main/dbip-city-mmdb/dbip-city-ipv4.mmdb" -O db-ip/dbip-city-lite.mmdb

      - name: Update DB-IP ASN
        continue-on-error: true
        run: wget -q --timeout=30 --tries=3 "https://cdn.jsdelivr.net/npm/@ip-location-db/dbip-asn-mmdb/dbip-asn-ipv4.mmdb" -O db-ip/dbip-asn-lite.mmdb

      - name: Update DB-IP Country
        continue-on-error: true
        run: wget -q --timeout=30 --tries=3 "https://cdn.jsdelivr.net/npm/@ip-location-db/dbip-country-mmdb/dbip-country-ipv4.mmdb" -O db-ip/dbip-country-lite.mmdb

      - name: Commit and Push changes
        run: |
          echo $(date +'%Y%m%d') > date.txt
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          
          if ! git diff --cached --quiet; then
            git commit -m "Update IP databases - $(date +'%Y-%m-%d %H:%M:%S')"
            
            for i in {1..3}; do
              if git push -v --progress; then
                echo "Push successful on attempt $i"
                break
              fi
              echo "Push failed on attempt $i, retrying..."
              sleep $((i * 5))
            done
          else
            echo "No changes detected, skipping commit"
          fi
